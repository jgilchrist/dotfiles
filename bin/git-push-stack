#!/bin/sh

set -euo pipefail

STACK_ID_DIRECTIVE='stack-id'
BRANCH_DIRECTIVE='branch'

target_branch() {
    stack_id="$( \
        git show --pretty='%B' \
        | sed -n 's/^'"${STACK_ID_DIRECTIVE}"': \([A-Za-z0-9_.-]\+\)$/\1/p' \
        ; )"
    branch="$( \
        git show --pretty='%B' \
        | sed -n 's/^'"${BRANCH_DIRECTIVE}"': \([A-Za-z0-9_.-]\+\)$/\1/p' \
        ; )"

    if [ -z "${stack_id}" ]; then
        printf >&2 'error: missing "%s" directive\n' "${STACK_ID_DIRECTIVE}"
        return 1
    fi
    if [ -z "${branch}" ]; then
        printf >&2 'error: missing "%s" directive\n' "${BRANCH_DIRECTIVE}"
        return 1
    fi

    if [ "$(printf '%s\n' "${stack_id}" | wc -l)" -gt 1 ]; then
        printf >&2 'error: multiple "%s" directives\n' "${STACK_ID_DIRECTIVE}"
        return 1
    fi
    if [ "$(printf '%s\n' "${branch}" | wc -l)" -gt 1 ]; then
        printf >&2 'error: multiple "%s" directives\n' "${BRANCH_DIRECTIVE}"
        return 1
    fi

    printf 'stack/%s/%s\n' "${stack_id}" "${branch}"
}

main() {
    remote="${1:-upstream}"
    branch="$(target_branch)"
    set -x
    git push --force-with-lease "${remote}" HEAD:refs/heads/"${branch}"
}

main "$@"
